<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Clientes - Banco Azteca</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #ffffff, #e6f4ea);
      font-family: "Poppins", sans-serif;
    }

    .modal-content {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border-radius: 1rem;
    }

    .btn-azteca {
      background-color: #006341;
      color: white;
      border: none;
    }

    .btn-azteca:hover {
      background-color: #00914c;
    }

    .table thead {
      background-color: #006341;
      color: white;
    }

    .modal-header {
      background-color: #006341;
      color: white;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }

    input:invalid {
      border: 2px solid #dc3545;
    }

    input:valid {
      border: 2px solid #198754;
    }
  </style>
</head>

<body class="p-4">

  <div class="container text-center">
    <h2 class="fw-bold text-success mb-4">Gesti√≥n de Clientes - Banco Azteca</h2>

    <button class="btn btn-azteca btn-lg mb-3" data-bs-toggle="modal" data-bs-target="#modalRegistro">
      ‚ûï Registrar Cliente
    </button>

    <button class="btn btn-outline-success btn-lg mb-3" onclick="listarClientes()">
      üìã Listar Clientes
    </button>
  </div>

  <!-- Modal Registrar -->
  <div class="modal fade" id="modalRegistro" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Registrar Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formCliente">
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" id="nombre" class="form-control" required pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+" placeholder="Nombre completo">
            </div>
            <div class="mb-3">
              <label class="form-label">Fecha de Nacimiento</label>
              <input type="date" id="fechaNacimiento" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Celular</label>
              <input type="text" id="celular" class="form-control" required pattern="^[0-9]{10}$" placeholder="10 d√≠gitos">
            </div>
            <div class="mb-3">
              <label class="form-label">Correo Electr√≥nico</label>
              <input type="email" id="correoElectronico" class="form-control" required placeholder="ejemplo@correo.com">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-azteca" onclick="if(validarFormulario()) registrarCliente()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Listar -->
  <div class="modal fade" id="modalListar" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Clientes Registrados</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Fecha Nac.</th>
                <th>Celular</th>
                <th>Correo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaClientes"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    const API_URL = "http://localhost:9090/api/clientes";

    function validarFormulario() {
      const nombre = document.getElementById('nombre').value.trim();
      const fechaNacimiento = document.getElementById('fechaNacimiento').value;
      const celular = document.getElementById('celular').value.trim();
      const correo = document.getElementById('correoElectronico').value.trim();

      if (!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]+$/.test(nombre)) {
        Swal.fire('Error', 'El nombre solo debe contener letras.', 'error');
        return false;
      }

      const fechaNac = new Date(fechaNacimiento);
      const hoy = new Date();
      const edad = hoy.getFullYear() - fechaNac.getFullYear();
      const mes = hoy.getMonth() - fechaNac.getMonth();
      const edadFinal = mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate()) ? edad - 1 : edad;

      if (isNaN(fechaNac) || edadFinal < 18) {
        Swal.fire('Error', 'El cliente debe tener al menos 18 a√±os.', 'error');
        return false;
      }

      if (!/^[0-9]{10}$/.test(celular)) {
        Swal.fire('Error', 'El n√∫mero de celular debe tener 10 d√≠gitos.', 'error');
        return false;
      }

      const correoRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!correoRegex.test(correo)) {
        Swal.fire('Error', 'El formato del correo electr√≥nico no es v√°lido.', 'error');
        return false;
      }

      return true;
    }

    async function registrarCliente() {
      const cliente = {
        nombre: document.getElementById("nombre").value,
        fechaNacimiento: document.getElementById("fechaNacimiento").value,
        celular: document.getElementById("celular").value,
        correoElectronico: document.getElementById("correoElectronico").value
      };

      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cliente)
      });

      if (response.ok) {
        Swal.fire('¬°√âxito!', 'Cliente registrado correctamente', 'success');
        document.getElementById("formCliente").reset();
        listarClientes();
      } else {
        Swal.fire('Error', 'No se pudo registrar el cliente', 'error');
      }

    }

    async function listarClientes() {
      const response = await fetch(API_URL);
      const clientes = await response.json();

      const tbody = document.getElementById("tablaClientes");
      tbody.innerHTML = "";

      clientes.forEach(c => {
        const fila = `
          <tr>
            <td>${c.id}</td>
            <td>${c.nombre}</td>
            <td>${new Date(c.fechaNacimiento).toLocaleDateString()}</td>
            <td>${c.celular}</td>
            <td>${c.correoElectronico}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="editarCliente(${c.id})">‚úèÔ∏è</button>
              <button class="btn btn-danger btn-sm" onclick="eliminarCliente(${c.id})">üóëÔ∏è</button>
              <button class="btn btn-success btn-sm" onclick="descargarCliente(${c.id})">‚¨áÔ∏è</button>
            </td>
          </tr>`;
        tbody.innerHTML += fila;
      });

      const modal = new bootstrap.Modal(document.getElementById("modalListar"));
      modal.show();
    }

    async function eliminarCliente(id) {
      const confirm = await Swal.fire({
        title: '¬øEliminar cliente?',
        text: 'Esta acci√≥n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
      });

      if (confirm.isConfirmed) {
        const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        if (response.ok) {
          Swal.fire('Eliminado', 'Cliente eliminado correctamente', 'success');
          listarClientes();
        } else {
          Swal.fire('Error', 'No se pudo eliminar el cliente', 'error');
        }
      }
    }

    async function descargarCliente(id) {
      const response = await fetch(`${API_URL}/${id}`);
      const cliente = await response.json();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Banco Azteca - Registro de Cliente", 20, 20);
      doc.setFontSize(12);
      doc.text(`ID: ${cliente.id}`, 20, 40);
      doc.text(`Nombre: ${cliente.nombre}`, 20, 50);
      doc.text(`Fecha de Nacimiento: ${new Date(cliente.fechaNacimiento).toLocaleDateString()}`, 20, 60);
      doc.text(`Celular: ${cliente.celular}`, 20, 70);
      doc.text(`Correo: ${cliente.correoElectronico}`, 20, 80);

      doc.save(`Cliente_${cliente.nombre.replace(/\s+/g, '_')}.pdf`);

    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
